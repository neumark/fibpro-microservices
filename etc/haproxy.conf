global
    daemon
    maxconn 256

defaults
    option httpclose # kill keep-alive - we had strange side-effects for grunt server at crm
    mode http
    timeout connect 200000ms
    timeout client  200000ms
    timeout server  200000ms

frontend https-in
    bind *:8443 ssl crt ./src/config/localhost.pem
    http-request set-header X-Forwarded-Proto https
    default_backend https

frontend http-in
    bind *:8000

    # cover
    acl cover-urls-acl         path    /
    acl cover-urls-acl         url_beg /index
    acl cover-urls-acl         url_beg /tour
    acl cover-urls-acl         url_beg /cover
    acl cover-urls-acl         url_beg /features
    acl cover-urls-acl         url_beg /gallery

    # your
    acl your-urls-acl          url_beg /your
    acl your-urls-acl          url_beg /profile/welcome
    acl your-urls-acl          url_beg /welcome

    # settingspage
    acl settingspage-urls-acl  url_beg /settingspage/jsi18n
    acl settingspage-urls-acl  url_beg /settings-beta
    acl settingspage-urls-acl  url_beg /api/v2/settingspage

    # Dynapps ACLs - synchronized with preprod haproxy cfg
    # editor page
    acl dynapps-urls-acl       url_reg ^/(prezi/)?\d{1,6}/edit/  # old preziId
    acl dynapps-urls-acl       url_reg ^/[0-9a-z\-_]{12}/edit/   # oid # opened for the office
    # dynapps-specific error pages
    acl dynapps-urls-acl       url_beg /no-meeting
    acl dynapps-urls-acl       url_beg /su-alert

    # Dynapps ACLs - for local development only
    acl dynapps-urls-acl       url_beg /static/

    # editor page
    acl dynapps-urls-acl       url_reg ^/(prezi/)?\d{1,6}/edit/ # old preziId
    acl dynapps-urls-acl       url_reg ^/[0-9a-z\-_]{12}/edit/  # oid

    # other dynapps urls
    acl dynapps-urls-acl       url_beg /dynapps
    acl dynapps-urls-acl       url_beg /create-prezi/

    # featureswitcher
    acl featureswitcher-urls-acl        url_beg /featureswitcher
    acl featureswitcher-urls-acl        url_beg /featureswitcher/static/

    # presentationservice
    acl presentationservice-urls-acl    url_reg ^/api/v2/presentation/
    acl presentationservice-urls-acl    url_reg ^/api/v3/presentation/
    acl presentationservice-urls-acl    url_reg ^/api/v4/presentation/
    acl presentationservice-urls-acl    url_reg ^/api/v2/grouprelation/
    # This single URL goes to zuisite because all the data for it is still zuisite related.
    acl zuisite-urls-acl                url_reg ^/my/prezi/list/details/
    acl presentationservice-urls-acl    url_reg ^/my/prezi/list/($|\?.*)
    acl presentationservice-urls-acl    url_reg ^/my/prezi/list/all/
    acl presentationservice-urls-acl    url_reg ^/my/prezi/list/autorefresh/
    acl presentationservice-urls-acl    url_reg ^/my/prezi/list/changed/

    # groups
    acl groups-urls-acl                 url_reg ^/api/v2/group/
    acl groups-urls-acl                 url_reg ^/api/v3/group/

    #contactservice
    acl contactservice-urls-acl         url_reg ^/contact_service/

    #authservice
    acl authservice-urls-acl            url_reg ^/api/v2/auth/
    acl authservice-urls-acl            url_reg ^/api/v3/preziuser/

    #groupservice
    acl groupservice-urls-acl           url_reg ^/groupservice/

    #supportsite
    acl supportsite-urls-acl            url_reg ^/support/
    acl supportsite-urls-acl            url_reg ^/contact-us/

    # paymentservice
    acl paymentservice-urls-acl         url_beg /api/v1/braintree/
    acl paymentservice-urls-acl         url_beg /paymentservice/
    acl paymentservice-urls-acl         url_beg /api/v2/group_payment/
    acl paymentservice-urls-acl         url_beg /api/v1/tax/
    acl paymentservice-urls-acl         url_beg /api/v2/payment/
    acl paymentservice-urls-acl         url_beg /api/v2/payment_ex/
    acl paymentservice-urls-acl         url_beg /api/v2/team-membership/

    # signup
    acl signup-urls-acl                 url_reg ^/pricing(?!/group)
    acl signup-urls-acl                 url_beg /api/v1/signup/
    # Edu signups are still handled in the zuisite backend.
    acl zuisite-urls-acl                url_beg /signup/verify/edu
    acl zuisite-urls-acl                url_beg /signup/edu
    acl signup-urls-acl                 url_beg /signup
    acl signup-urls-acl                 url_beg /plan
    acl signup-urls-acl                 url_beg /upgrade
    acl signup-urls-acl                 url_beg /ocpromo

    # connected microsite
    acl connected-microsite-acl         url_beg /connected

    # landingdjango
    acl landingdjango-acl               url_reg ^/[0-9a-z\-_]{12}/[0-9a-z\-_]+/
    acl landingdjango-acl               url_reg ^/[0-9a-z\-_]{12}/$
    acl landingdjango-acl               url_reg ^/\d{1,6}/$
    acl landingdjango-acl               url_reg ^/player/$
    acl landingdjango-acl               url_reg ^/embed/
    acl landingdjango-acl               url_reg ^/loadui/
    acl landingdjango-acl               url_reg ^/\d+/view/$
    acl landingdjango-acl               url_reg ^/[0-9a-z\-_]{12}/view/
    acl landingdjango-acl               url_reg ^/[0-9a-z\-_]{12}/present/
    acl landingdjango-acl               url_beg /landingdjango/static/

    # mul administration app
    acl mul-admin-app-urls-acl          url_beg /organizations/
    acl mul-admin-app-urls-acl          url_beg /mul_admin_app/
    acl mul-admin-app-urls-acl          url_beg /muladminapp/

    # staticpages app
    acl staticpages-urls-acl            url_beg /about
    acl staticpages-urls-acl            url_beg /ambassadors
    acl staticpages-urls-acl            url_beg /community
    acl staticpages-urls-acl            url_beg /cookie-policy
    acl staticpages-urls-acl            url_beg /copyright
    acl staticpages-urls-acl            url_beg /customers
    acl staticpages-urls-acl            url_beg /desktop-eula
    acl staticpages-urls-acl            url_beg /doodle
    acl staticpages-urls-acl            url_beg /educators
    acl staticpages-urls-acl            url_beg /guides
    acl staticpages-urls-acl            url_beg /leadership
    acl staticpages-urls-acl            url_beg /open-source-thanks
    acl staticpages-urls-acl            url_beg /about-team
    acl staticpages-urls-acl            url_beg /our-values
    acl staticpages-urls-acl            url_beg /privacy-policy
    acl staticpages-urls-acl            url_beg /prezi-for-education
    acl staticpages-urls-acl            url_beg /staticpages
    acl staticpages-urls-acl            url_beg /terms-of-use
    acl staticpages-urls-acl            url_beg /redirect
    acl staticpages-urls-acl            url_beg /webdevstarterkit
    acl staticpages-urls-acl            url_beg /community-templates

    # campaigns
    acl campaigns-urls-acl              url_beg /bono-chooses-prezi-at-ted-2013
    acl campaigns-urls-acl              url_beg /business
    acl campaigns-urls-acl              url_beg /con-prezi-podras
    acl campaigns-urls-acl              url_beg /create-better-presentations
    acl campaigns-urls-acl              url_beg /downloading
    acl campaigns-urls-acl              url_beg /powerpoint-alternative
    acl campaigns-urls-acl              url_beg /presentation-software
    acl campaigns-urls-acl              url_beg /prezi-for-business
    acl campaigns-urls-acl              url_beg /prezume
    acl campaigns-urls-acl              url_beg /scrapbook
    acl campaigns-urls-acl              url_beg /sxsw/subscribe
    acl campaigns-urls-acl              url_beg /zooming-presentations
    acl campaigns-urls-acl              url_beg /hr-training
    acl campaigns-urls-acl              url_beg /ted-talks
    acl campaigns-urls-acl              url_beg /catchbox
    acl campaigns-urls-acl              url_beg /slides-vs-prezi

    # press component
    acl press-urls-acl                  path /press
    acl press-urls-acl                  url_beg /press/
    acl press-urls-acl                  url_beg /presskit

    # mul signup app
    acl mulsignupservice-urls-acl       url_beg /teams
    acl mulsignupservice-urls-acl       url_beg /groupsignup
    acl mulsignupservice-urls-acl       url_beg /mulsignupservice
    acl mulsignupservice-urls-acl       url_beg /pricing/group

    # usesettings service
    acl usersettingsservice-acl         url_beg /api/usersettings
    acl usersettingsservice-acl         url_beg /api/v1/segmentation
    acl usersettingsservice-acl         url_beg /api/v1/personalization
    acl usersettingsservice-acl         url_beg /api/v2/usersettings
    acl usersettingsservice-acl         url_beg /api/v3/usersettings

    # licenseservice
    acl licenseservice-acl              url_beg /api/v1/licensetype

    # login
    acl login-acl                       url_beg /login

    # salestools
    acl salestools-urls-acl             url_beg /api/v1/salestools/pardot/

    # boxfish
    acl boxfish-urls-acl                url_beg /prezi-core-data
    acl boxfish-urls-acl                url_beg /boxfish
    acl boxfish-urls-acl                url_beg /modules
    acl boxfish-urls-acl                url_beg /resources/fonts/
    acl boxfish-urls-acl                url_beg /proxy
    acl boxfish-urls-acl                url_beg /webfonts

    # prezipage
    acl prezipage-urls-acl              url_beg /p/
    acl prezipage-urls-acl              url_beg /prezipage
    acl prezipage-urls-acl              url_beg /api/v1/share

    # share
    acl share-urls-acl                  url_end share.js
    acl share-urls-acl                  url_beg /shareng

    # email verification
    acl emailverification-urls-acl      url_beg /api/v2/emailverification

    # Block favicon because:
    #  it's directed to zuisite
    #  zuisite doesn't serve a favicon (it's done by apache on production, nothing on local)
    #  zuisite serves a 404 page, containing session cookies
    #  which fucks up any other app's session-based authentication
    acl favicon-url-acl        url /favicon.ico
    http-request deny if favicon-url-acl

    # clickjacking protection
    acl json-response                   shdr_beg(Content-Type) -i application/json
    rspadd X-Frame-Options:\ deny if json-response
    rspidel ^X-Frame-Options:.* if json-response

    use_backend dynapps if dynapps-urls-acl
    use_backend your if your-urls-acl
    use_backend settingspage if settingspage-urls-acl
    use_backend cover if cover-urls-acl
    use_backend featureswitcher if featureswitcher-urls-acl
    use_backend presentationservice if presentationservice-urls-acl
    use_backend zuisite if zuisite-urls-acl
    use_backend groups if groups-urls-acl
    use_backend contactservice if contactservice-urls-acl
    use_backend authservice if authservice-urls-acl
    use_backend groupservice if groupservice-urls-acl
    use_backend supportsite if supportsite-urls-acl
    use_backend paymentservice if paymentservice-urls-acl
    use_backend signup if signup-urls-acl
    use_backend connected-microsite if connected-microsite-acl
    # staticpages backend needs to be listed before landingdjango for 12 character urls ie. /terms-of-use etc.
    use_backend staticpages if staticpages-urls-acl
    use_backend landingdjango if landingdjango-acl
    use_backend mul-admin-app if mul-admin-app-urls-acl
    use_backend staticpages if campaigns-urls-acl
    use_backend mulsignupservice-app if mulsignupservice-urls-acl
    use_backend usersettingsservice if usersettingsservice-acl
    use_backend press if press-urls-acl
    use_backend licenseservice if licenseservice-acl
    use_backend login if login-acl
    use_backend salestools if salestools-urls-acl
    use_backend boxfish if boxfish-urls-acl
    use_backend share if share-urls-acl
    use_backend prezipage if prezipage-urls-acl
    use_backend emailverificationservice if emailverification-urls-acl
    default_backend zuisite

backend https
    server s1 127.0.0.1:8000

backend zuisite
    server s1 127.0.0.1:8009 maxconn 32

backend dynapps
    server s2 127.0.0.1:8008 maxconn 32

backend featureswitcher
    server s3 127.0.0.1:8007 maxconn 32

backend your
    server s2 127.0.0.1:8006 maxconn 32

backend cover
    server s11 127.0.0.1:8011 maxconn 32

backend presentationservice
    server s4 127.0.0.1:8086 maxconn 32

backend groups
    server s4 127.0.0.1:8086 maxconn 32

backend contactservice
    server s5 127.0.0.1:18001 maxconn 32
    reqirep ^([^\ ]*)\ /contact_service/(.*)    \1\ /\2

backend authservice
    server s6 127.0.0.1:8087 maxconn 32

backend groupservice
    server s7 127.0.0.1:16384 maxconn 32
    reqirep ^([^\ ]*)\ /groupservice/(.*)    \1\ /\2

backend supportsite
    server s8 127.0.0.1:8010 maxconn 32

backend paymentservice
    server s7 127.0.0.1:9080 maxconn 32
    reqirep ^([^\ ]*)\ /paymentservice/(.*)    \1\ /\2

backend signup
    server s13 127.0.0.1:8013 maxconn 32

backend connected-microsite
    server s12 127.0.0.1:8015 maxconn 32

backend landingdjango
    server s13 127.0.0.1:8016 maxconn 32

backend licenseservice
    server s16 127.0.0.1:8019 maxconn 32

backend login
    server s14 127.0.0.1:8018 maxconn 32

backend salestools
    server s15 127.0.0.1:8021 maxconn 32

backend mul-admin-app
    server s13 127.0.0.1:1099 maxconn 32

backend staticpages
    server s42 127.0.0.1:8042 maxconn 32

backend mulsignupservice-app
    server s13 127.0.0.1:9082 maxconn 32

backend usersettingsservice
    server s13 127.0.0.1:8085 maxconn 32

backend press
    server s43 127.0.0.1:8043 maxconn 32

backend prezipage
    server s44 127.0.0.1:9087 maxconn 32

backend settingspage
    server s50 127.0.0.1:8050 maxconn 32

backend emailverificationservice
    server s51 127.0.0.1:8888 maxconn 32

# Local boxfish dev server
backend boxfish
    server s43 127.0.0.1:9081 maxconn 32
    reqrep ^([^\ :]*)\ /boxfish/(.*) \1\ /\2
    reqrep ^([^\ :]*)\ /prezipage/(.*) \1\ /\2

# Config for the CRM
frontend crm
    bind *:8100

    acl frontend-urls-acl url_beg /ng
    use_backend crm_angular if frontend-urls-acl

    default_backend crm_django

backend crm_django
    server s9 127.0.0.1:8192 maxconn 32

backend crm_angular
    reqrep ^([^\ ]*)\ /ng/(.*)     \1\ /\2
    server s10 127.0.0.1:8193 maxconn 32

backend share
    reqirep ^([^\ :]*)\ /shareng/(.*)   \1\ /\2
    server s42 127.0.0.1:9000 maxconn 32
